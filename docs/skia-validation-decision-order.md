# Skia移植：判断の順序（切り分けの基準）

## 目的
Skia側での鉛筆再現（LUT方式＋紙目テクスチャ＋`SrcOver`前提）を進める際に、
不一致の原因を「素材由来」か「ストローク実装由来」かで切り分け、判断を迷走させないための手順を定義する。

---

📋 分析結果 Summary:
- まず **dot（スタンプ素材）**を合わせる → 次に **線（ストローク）**を合わせる、の順が妥当。
- すでに揃っている観測データ（`dot512-material-*` / `radial-falloff-*` / `center-alpha-vs-N-vs-P.csv` / `alpha-samples-vs-N-vs-P.csv`）は、そのままテストベクタとして使える。
- 濃すぎ問題は合成モードより **スタンプ密度・重なり制御**が主因になりやすい。

---

## 判断の順序（切り分けの基準）

### 1) dot（スタンプ素材）の再現が合っているか
**目的**
- `F(r_norm)` LUT と `paper-noise` の掛け方（正規/反転含む）が正しいかを確認する。

**判定方法**
- 観測PNG（`dot512-material-S{S}-P{P}-N{N}.png`）と、Skia側で同条件により生成したPNGを比較する。
- 比較は「512×512全域」ではなく、**直径Sの中心円（radius=S/2）内のみ**を対象にする。
- 指標は **MAE/RMSE（αのみ）**が扱いやすい。

**合格の目安（運用で調整）**
- paper-noiseの正規/反転の選択が安定して決まる。
- 代表サブセットで明らかに悪いケースが残らない。

---

### 2) N（重ね回数）挙動が合っているか
**目的**
- 合成が `SrcOver` 前提で良いか、重ねによる飽和が観測と一致するかを確認する。

**判定方法**
- `center-alpha-vs-N-vs-P.csv` と、Skia側で同条件 `S,P,N` を生成した中心αを比較する。
- 少なくとも中心近傍は `SrcOver` の理想形（指数飽和）
  - `A_N = 1 - (1 - A_1)^N`
  から大きく外れないことを確認する。

**注**
- ここが合わない場合、まず「合成則」より先に **過密スタンプ（点列生成・間隔・間引き）**を疑う。

---

### 3) 線（ストローク）で濃すぎ/薄すぎが出ないか
**目的**
- ISF→点列化→再サンプリング→スタンプ間隔の設計が適切かを確認する。

**判定方法**
- 濃すぎが出るストロークで、
  - 距離ベースの間引き
  - Overwrite（差分塗り）
  の導入で症状が改善するかを確認する。

**合格の目安（運用で調整）**
- 低速の線で極端に黒くならない。
- 短い区間で塗り潰しが発生しない（またはUWPと同程度）。

---

## 補足：代表サブセット
代表サブセット（36ケース）の一覧は以下。
- `docs/representative-sample-subset.md`

必要なら、起動時コスト削減のために 9〜12件へ絞った判定セット（例：`S={10,100,200}×P={0.05,0.5,1.0}×N=10`）を用意し、結果をキャッシュする。
